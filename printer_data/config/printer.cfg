[include stealthburner.cfg]
[include homing.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include stealthburner_leds.cfg]
[include macros/fan_tach_monitor.cfg]

[exclude_object]

# Host-MCU definieren
[mcu host_mcu]
serial: /tmp/klipper_host_mcu

[mcu]
##  Obtain definition by "ls /dev/serial/by-id/*" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_2D003B000851313031393839-if00
restart_method: command
##--------------------------------------------------------------------

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor RaspberryPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[printer]
kinematics: corexy
max_velocity: 800  
max_accel: 10000             #Max 4000
max_z_velocity: 30          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 500
square_corner_velocity: 15.0

[force_move]
enable_force_move: True

#####################################################################
#   Cartographer Settings
#####################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_33001F00104330394D363620-if00


[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0 
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 25                                                     #    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.5                                               #   Backlash compensation distance for removing Z backlash before measuring the sensor response.
sensor: cartographer                                             #    this must be set as cartographer unless using IDM etc.
sensor_alt: carto                                                #    alternate name to call commands. CARTO_TOUCH etc
mesh_runs: 2                                                     #    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 175, 175    #    set this to the middle of your bed
speed: 200    #    movement speed of toolhead during bed mesh
horizontal_move_z: 5    #    height of scanner during bed mesh scan
mesh_min: 25, 30    #    start point of bed mesh [X, Y]
mesh_max: 325, 315    #    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[adxl345]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 20


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 351
position_max: 351
homing_speed: 80
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: true
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG6
driver_SGTHRS: 100

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_y:virtual_endstop #Y_STOP
position_min: 0
position_endstop: 358
position_max: 358
homing_speed: 40 #50
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: true
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG9
driver_SGTHRS: 95



[input_shaper]
#shaper_type_x = ei
#shaper_freq_x = 66.6
#shaper_type_y = ei
#shaper_freq_y = 49.4


#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: probe:z_virtual_endstop # uses cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 310

##--------------------------------------------------------------------
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769


#####################################################################
#   Fan Control
#####################################################################

[controller_fan controller_fan]
pin: PA8
kick_start_time: 0.5
heater: heater_bed

[controller_fan controller_fan2]
pin: PE5
kick_start_time: 0.5
heater: heater_bed


#[temperature_fan controller_fan]
#pin: PD12
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#sensor_type: temperature_mcu
#sensor_pin:
#max_delta:
#min_temp: 40
#max_temp: 60
# Siehe Abschnitt "Extruder" für eine Beschreibung der oben genannten Parameter.
#pid_Kp:
#pid_Ki:
#pid_Kd:
# Die Proportional- (pid_Kp), Integral- (pid_Ki) und Ableitungswerte (pid_Kd) für das PID-Regelsystem.
# Klipper bewertet die PID-Einstellungen mit der folgenden allgemeinen Formel:
# fan_pwm = max_power - (Kp*e + Ki*integral(e) - Kd*derivative(e)) / 255
# wobei "e" "Zieltemperatur - gemessene Temperatur" ist und "fan_pwm" die angeforderte Lüfterrate ist,
# wobei 0,0 für "voll aus" und 1,0 voll ein ist. Die Parameter pid_Kp, pid_Ki und pid_Kd müssen
# bereitgestellt werden, wenn der PID-Regelalgorithmus aktiviert ist.
#pid_deriv_time: 2.0
# Ein Zeitwert (in Sekunden), über den die Temperaturmessungen geglättet werden, wenn der PID-
# Regelalgorithmus verwendet wird. Dies kann die Auswirkung Auswirkungen des Messrauschens. Die
# Vorgabe ist 2 Sekunden.
#target_temp: 40.0
# Eine Temperatur (in Celsius), die die Zieltemperatur sein wird. Die Vorgabe ist 40 Grad.
#max_speed: 1.0
# Die Lüftergeschwindigkeit (ausgedrückt als Wert von 0,0 bis 1,0), auf die der Lüfterausgedrückt als
# Wert von 0,0 bis 1,0), auf die der Lüfter eingestellt # wird, wenn die Sensortemperatur den
# eingestellten Wert überschreitet. Der Standardwert ist 1.0.
#min_speed: 0.3


[temperature_fan chamber]
pin: PD14
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time:0.01
off_below:0.1
sensor_type: DS18B20
serial_no: 28-01131a4d91b8
sensor_mcu: host_mcu  
ds18_report_time: 3.0
min_temp: 0
max_temp: 70
target_temp: 35.0
control: watermark
gcode_id: C

#####################################################################
#   LED Control
#####################################################################

[output_pin Licht]
pin: PA3
pwm:true
shutdown_value: 0
value:1
cycle_time: 0.01

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[safe_z_home]
home_xy_position: 175,175
z_hop: 10
speed: 250

[quad_gantry_level]

gantry_corners:
   -60,-10
   410,420
points:
   50,25
   50,275
   300,275
   300,25

speed: 350
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 20

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#####################################################################
#   Macros
#####################################################################

[pause_resume]
# optional kannst du hier Parameter wie Höhe nach Pause definieren
# z.B. park height oder X/Y Positionen für Pause

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    PARK
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  50
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E{load_distance} F{max_velocity} # fast-load
    G1 E{purge_distance} F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  100
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E{purge_distance} F{speed} # purge
    G1 E-{unload_distance} F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro M141]                                                #Kammertemperatur von Slicer zu Klipper uebersetzen
gcode:
    {% if 'S' in params %}
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={params.S}
    {% else %}
    RESPOND PREFIX="M141" MSG="Missing parameter Snn"
    {% endif %}

[gcode_macro PRINT_START]
gcode:
  {% set bed = params.BED|default(60)|int %}
  {% set extruder = params.EXTRUDER|default(210)|int %}

  {% if bed >= 90 %}
    SET_DISPLAY_TEXT MSG="Starte: vollständige Routine"
    _PRINT_START_FULL BED={bed} EXTRUDER={extruder}
  {% else %}
    SET_DISPLAY_TEXT MSG="Starte: Schnellstart"
    PRINT_START_FAST BED={bed} EXTRUDER={extruder}
  {% endif %}

[gcode_macro PRINT_START_FAST]
description: Schneller Start für wiederholte Drucke
gcode:
  {% set bed = params.BED|default(60)|int %}
  {% set extruder = params.EXTRUDER|default(210)|int %}
  {% set chamber = params.CHAMBER|default(35)|int %}
  {% set x_center = printer.toolhead.axis_maximum.x/2 %}
  {% set y_center = printer.toolhead.axis_maximum.y/2 %}

  SET_GCODE_OFFSET Z=0
  STATUS_HEATING
  SET_DISPLAY_TEXT MSG="Vorheizen (schnellstart)"

  # Heize Hotend & Bett gleichzeitig, ohne zu warten
  M104 S{extruder}
  M140 S{bed}

  # Nur 1x tägliches QGL durchführen (Zeit sparen)
  {% if printer.quad_gantry_level.applied == False %}
    G28
    QUAD_GANTRY_LEVEL
  {% else %}
    G28 Z
  {% endif %}

  # Verwende gespeichertes Bett-Mesh statt neuem Scan
  BED_MESH_PROFILE LOAD=default

  # Warte auf Zieltemperaturen erst jetzt (schneller)
  M190 S{bed}
  M109 S{extruder}

  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Düse putzen"
  CLEAN_NOZZLE
  SET_DISPLAY_TEXT MSG="Düse referenzieren"
  CARTOGRAPHER_TOUCH
  SET_DISPLAY_TEXT MSG="Los geht's!"
  G1 X{x_center} Y{y_center} Z5 F8000


[gcode_macro _PRINT_START_FULL]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_GCODE_OFFSET Z=0                                 # Set offset to 0
  
  M104 S150  #Düse schon mal auf 150°C Aufheizen ohne zu warten
  M140 S{target_bed}

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  STATUS_HOMING                                         # Set LEDs to homing-mode
  SET_DISPLAY_TEXT MSG="So, wo ist denn eigentlich mein Druckkopf?"
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)
  SET_DISPLAY_TEXT MSG="Jetzt weiss ich wieder, wo mir der Kopf steht"
  
  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                           # Turn on the PT-fan

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    #SET_DISPLAY_TEXT MSG="Das Bett ist ganz kalt. Warten wir lieber mal 3min."               # Display info on display
    #G4 P180000                                          # Wait 5 min for the bedtemp to stabilize
  {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S150                                             # Heat hotend to 150c

  SET_DISPLAY_TEXT MSG="Jetzt wird das Gestell ausgerichtet"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  G1 Z30 F6000 
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  G28 Z                                                # Home Z again after QGL

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Lass mich noch schnell die Bettoberflaeche vermessen"                      # Display info on display
  STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  BED_MESH_CALIBRATE                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh
  SET_DISPLAY_TEXT MSG="Jetzt noch die Düse sauber machen"
  CLEAN_NOZZLE
  SET_DISPLAY_TEXT MSG="Ich ermittle nun den gaaanz genauen Düsenabstand zum Bett"
  CARTOGRAPHER_TOUCH                                   # Calibrate z offset only with hot nozzle

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Düse aufheizen: {target_extruder}°C"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  SET_DISPLAY_TEXT MSG="Ich drücke mir nun die ersten 5cm Filament raus"
  PURGE_NOZZLE
  SET_DISPLAY_TEXT MSG="Jetzt geht's los. Düse {target_extruder}°C, Bett {target_bed}°C"
  G90
  G1 Z5 F1000
  G1 X175 Y175 F16000



[gcode_macro CANCEL_PRINT]
description: Bricht den Druck sicher ab
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS                     ; Alle Heizelemente ausschalten
    M107                                 ; Part-Cooling-Fan aus
    G91
    G1 Z10 F3000                         ; Etwas anheben (relative Bewegung)
    G90
    G1 X350 Y350 F16000                  ; Kopf in Parkposition
    M18                                  ; Motoren deaktivieren
    CLEAR_PAUSE                          ; Alle Pausenstatus zurücksetzen
    SET_DISPLAY_TEXT MSG="Druck abgebrochen"

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament

    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan

    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


[gcode_macro CLEAN_NOZZLE]
variable_start_x: 313         # X-Position der Bürste (rechts hinten)
variable_start_y: 358         # Y-Position Mitte der Bürste
variable_start_z: 2.8         # Höhe über Bürste
variable_wipe_dist: -50       # Wischlänge in X-Richtung
variable_wipe_qty: 6          # Wie oft hin- und herwischen
variable_wipe_spd: 150        # Geschwindigkeit (mm/s)
variable_y_amplitude: 2.0     # Zickzack-Auslenkung in Y-Richtung (+/- mm)
variable_y_step: 0.5          # Schrittweite pro Wischbewegung
variable_raise_distance: 30   # Anhebehöhe nach dem Wischen

gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  G90
  G1 X{start_x} Y{start_y} Z{start_z} F5000

  {% set current_y = start_y %}
  {% set dir = 1 %}

  # Haupt-Wischschleife
  {% for i in range(wipe_qty) %}
    # Zickzack über Y
    {% for offset in range(-y_amplitude|int, y_amplitude|int + 1, y_step|int) %}
      G1 X{start_x + (wipe_dist if dir == 1 else 0)} Y{start_y + offset} F{wipe_spd * 60}
      G1 X{start_x + (0 if dir == 1 else wipe_dist)} Y{start_y + offset} F{wipe_spd * 60}
    {% endfor %}
    {% set dir = dir * -1 %}
  {% endfor %}

  G91
  G1 Z{raise_distance} F1000
  G90

[gcode_macro PURGE_NOZZLE]
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  # Prüfen ob Hotend-Temperatur >= 180°C, sonst vorheizen
  {% set current_temp = printer.extruder.temperature %}
  {% if current_temp < 180 %}
    M109 S180               ; auf 180°C vorheizen und warten
  {% endif %}

  G90                      ; absolute Positionierung
  G1 X350 Y358 Z2.8 F5000 ; zum Behälter fahren
  G92 E0                   ; Extruder nullen
  G1 E30 F100              ; 30 mm Filament extrudieren (10 mm/s)
  G92 E0                   ; Extruder wieder nullen

  CLEAN_NOZZLE             ; Düse reinigen



[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_z_offset = 0.035
#*#
#*# [scanner model default]
#*# model_coef = 1.5092638035040915,
#*# 	1.9312080264466045,
#*# 	0.7662534622402828,
#*# 	0.3951616289841105,
#*# 	0.22456808776817896,
#*# 	0.029459435831755323,
#*# 	-0.07131374548365897,
#*# 	0.10425387126481561,
#*# 	0.12319043327851449,
#*# 	-0.006975329077736644
#*# model_domain = 3.22431194029789e-07,3.2899413558884275e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.268064
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.134060, 0.133956, 0.134096, 0.132949, 0.130222, 0.121903, 0.111927, 0.104204, 0.096475, 0.090813, 0.087477, 0.086086, 0.086041, 0.086030, 0.084239, 0.084958, 0.086294, 0.086920, 0.088424, 0.092653, 0.099260, 0.108288, 0.114755, 0.119977, 0.123813, 0.129200, 0.134633, 0.135995, 0.138481, 0.137507
#*# 	  0.124427, 0.125205, 0.124010, 0.122802, 0.121194, 0.114174, 0.104360, 0.093245, 0.083689, 0.077341, 0.074996, 0.073980, 0.073242, 0.072205, 0.071300, 0.072967, 0.074100, 0.075508, 0.077138, 0.081069, 0.086604, 0.093289, 0.101007, 0.104660, 0.108983, 0.115088, 0.121211, 0.124289, 0.125856, 0.127827
#*# 	  0.110575, 0.111704, 0.109261, 0.110107, 0.110474, 0.103969, 0.093515, 0.081237, 0.069168, 0.062900, 0.059610, 0.058398, 0.058107, 0.058324, 0.055331, 0.056530, 0.058917, 0.060799, 0.061877, 0.064431, 0.069481, 0.077963, 0.082778, 0.087504, 0.091723, 0.097283, 0.102612, 0.105881, 0.111255, 0.113887
#*# 	  0.096035, 0.096108, 0.093959, 0.094767, 0.094707, 0.088867, 0.077532, 0.066750, 0.054676, 0.048194, 0.045372, 0.043641, 0.042847, 0.043396, 0.042060, 0.042437, 0.045260, 0.045991, 0.047065, 0.050983, 0.056493, 0.063307, 0.068823, 0.072617, 0.076681, 0.081760, 0.086666, 0.091240, 0.095255, 0.099357
#*# 	  0.091437, 0.089811, 0.089096, 0.086698, 0.084950, 0.078163, 0.068356, 0.059550, 0.050497, 0.045090, 0.041977, 0.039479, 0.040217, 0.038992, 0.037557, 0.037606, 0.039219, 0.040604, 0.043761, 0.046059, 0.050686, 0.058241, 0.064249, 0.066445, 0.070334, 0.076083, 0.081103, 0.085314, 0.090121, 0.094643
#*# 	  0.094571, 0.092319, 0.088742, 0.086264, 0.080570, 0.070314, 0.064688, 0.058351, 0.051261, 0.046543, 0.042516, 0.041225, 0.041436, 0.039377, 0.037358, 0.037207, 0.038785, 0.039617, 0.042646, 0.044471, 0.049279, 0.055897, 0.062493, 0.066675, 0.067550, 0.072280, 0.078724, 0.085353, 0.088058, 0.092021
#*# 	  0.098950, 0.096030, 0.091637, 0.087770, 0.080264, 0.066230, 0.062658, 0.057772, 0.050312, 0.046025, 0.042024, 0.039607, 0.038809, 0.038304, 0.035974, 0.034017, 0.036249, 0.037293, 0.038775, 0.041281, 0.046050, 0.052944, 0.057209, 0.059618, 0.064847, 0.069224, 0.074186, 0.078989, 0.085285, 0.089582
#*# 	  0.107734, 0.101673, 0.097286, 0.092470, 0.085080, 0.073912, 0.068129, 0.061288, 0.054693, 0.048852, 0.043855, 0.041686, 0.039316, 0.038688, 0.035976, 0.033994, 0.035255, 0.036220, 0.036143, 0.037639, 0.041614, 0.047932, 0.053332, 0.057006, 0.060441, 0.066768, 0.072004, 0.078968, 0.083548, 0.087429
#*# 	  0.115078, 0.108754, 0.101764, 0.096460, 0.090142, 0.080519, 0.073215, 0.064164, 0.055686, 0.051338, 0.046867, 0.042982, 0.041651, 0.037806, 0.035333, 0.036141, 0.035284, 0.035827, 0.035897, 0.035861, 0.039684, 0.046240, 0.049511, 0.053815, 0.057898, 0.064413, 0.071099, 0.075754, 0.083795, 0.088974
#*# 	  0.117242, 0.110185, 0.102348, 0.095185, 0.086945, 0.077661, 0.069987, 0.061917, 0.054668, 0.048695, 0.044685, 0.040579, 0.035996, 0.029339, 0.026653, 0.029972, 0.031479, 0.029706, 0.030207, 0.032233, 0.035367, 0.039029, 0.043649, 0.047093, 0.051159, 0.058807, 0.065711, 0.072221, 0.077294, 0.082546
#*# 	  0.115578, 0.108848, 0.101817, 0.093233, 0.085519, 0.076510, 0.066282, 0.058551, 0.052829, 0.045502, 0.039538, 0.035724, 0.031257, 0.020074, 0.021004, 0.024303, 0.023369, 0.024208, 0.022923, 0.025383, 0.029455, 0.032877, 0.035676, 0.040124, 0.045941, 0.051979, 0.058159, 0.064747, 0.071862, 0.076221
#*# 	  0.112476, 0.106575, 0.099351, 0.091785, 0.083256, 0.073732, 0.064508, 0.057879, 0.049931, 0.043014, 0.034829, 0.028805, 0.022658, 0.016891, 0.020239, 0.020754, 0.019531, 0.019412, 0.019562, 0.020887, 0.024369, 0.028594, 0.029925, 0.035516, 0.041928, 0.046928, 0.054759, 0.061142, 0.067603, 0.072539
#*# 	  0.107409, 0.099880, 0.093337, 0.086811, 0.078134, 0.069238, 0.061417, 0.053347, 0.045923, 0.038373, 0.030193, 0.022686, 0.016602, 0.015276, 0.017861, 0.017743, 0.016280, 0.016924, 0.016919, 0.018184, 0.021389, 0.026635, 0.029356, 0.032823, 0.038830, 0.045972, 0.052314, 0.057084, 0.064262, 0.071613
#*# 	  0.098163, 0.090857, 0.084159, 0.077300, 0.069117, 0.058252, 0.051459, 0.044889, 0.037563, 0.029159, 0.022934, 0.016261, 0.009524, 0.009512, 0.009657, 0.010055, 0.010027, 0.009443, 0.010225, 0.011408, 0.015343, 0.019946, 0.024182, 0.029347, 0.032869, 0.039193, 0.045643, 0.053244, 0.058658, 0.063613
#*# 	  0.089383, 0.083003, 0.077488, 0.070661, 0.062720, 0.053863, 0.045453, 0.039885, 0.033066, 0.025766, 0.018652, 0.012419, 0.009415, 0.006857, 0.006474, 0.006131, 0.007108, 0.006168, 0.006242, 0.007788, 0.011986, 0.017152, 0.022013, 0.026522, 0.032231, 0.039031, 0.044909, 0.051061, 0.059454, 0.062943
#*# 	  0.083380, 0.077878, 0.070999, 0.064418, 0.056506, 0.048746, 0.041217, 0.034088, 0.029205, 0.022693, 0.016060, 0.010667, 0.007913, 0.006144, 0.003177, 0.001728, 0.003425, 0.001849, 0.003150, 0.004098, 0.009473, 0.015970, 0.020258, 0.024477, 0.031080, 0.037143, 0.043756, 0.051740, 0.058421, 0.062225
#*# 	  0.077229, 0.071071, 0.063271, 0.056516, 0.049447, 0.041476, 0.034905, 0.028714, 0.021988, 0.016337, 0.011990, 0.006414, 0.002983, 0.000014, -0.002713, -0.003555, -0.002681, -0.001286, -0.000026, 0.001172, 0.005914, 0.010935, 0.016117, 0.019730, 0.025489, 0.035263, 0.041786, 0.048475, 0.058009, 0.064625
#*# 	  0.071367, 0.065981, 0.059317, 0.051432, 0.044783, 0.035786, 0.029774, 0.023421, 0.018891, 0.012045, 0.006670, 0.003351, -0.001182, -0.003438, -0.005219, -0.005624, -0.003654, -0.003230, -0.000223, 0.002620, 0.003454, 0.009258, 0.015100, 0.020372, 0.024099, 0.032129, 0.041739, 0.050880, 0.057673, 0.064467
#*# 	  0.071025, 0.066820, 0.057743, 0.049299, 0.042803, 0.037178, 0.030969, 0.023956, 0.017255, 0.011255, 0.006164, 0.002445, -0.000406, -0.003357, -0.006647, -0.006597, -0.003306, -0.002974, -0.000778, -0.000033, 0.005150, 0.010083, 0.015794, 0.019593, 0.025393, 0.032505, 0.040667, 0.050695, 0.060034, 0.066034
#*# 	  0.073592, 0.067303, 0.060421, 0.052310, 0.045429, 0.039453, 0.033126, 0.026045, 0.021024, 0.013221, 0.007543, 0.003266, 0.001473, -0.001721, -0.006337, -0.004252, -0.001376, -0.000189, -0.001625, -0.000071, 0.005649, 0.011542, 0.015757, 0.018899, 0.022799, 0.032265, 0.040705, 0.050041, 0.057889, 0.064364
#*# 	  0.078156, 0.073314, 0.065244, 0.059427, 0.052218, 0.044979, 0.039495, 0.033409, 0.026272, 0.019990, 0.014243, 0.009927, 0.006125, 0.002583, -0.000214, -0.000726, 0.001567, 0.003099, 0.003872, 0.004052, 0.008271, 0.014403, 0.018623, 0.019986, 0.025197, 0.034235, 0.042293, 0.049397, 0.059531, 0.067092
#*# 	  0.090236, 0.084615, 0.079857, 0.073738, 0.065724, 0.058423, 0.053544, 0.046833, 0.039826, 0.033273, 0.027508, 0.022982, 0.017943, 0.013806, 0.012790, 0.012252, 0.012888, 0.012883, 0.014553, 0.015752, 0.018208, 0.022473, 0.026117, 0.030600, 0.034190, 0.041829, 0.051382, 0.060577, 0.066577, 0.073313
#*# 	  0.100989, 0.096428, 0.090562, 0.084966, 0.079597, 0.073207, 0.064260, 0.056938, 0.051812, 0.046072, 0.039995, 0.034034, 0.030868, 0.025896, 0.023638, 0.022764, 0.024255, 0.023628, 0.022833, 0.023222, 0.026233, 0.029743, 0.033577, 0.037689, 0.042272, 0.050554, 0.057364, 0.065054, 0.076382, 0.081318
#*# 	  0.104472, 0.099654, 0.094917, 0.088183, 0.083058, 0.076710, 0.070312, 0.062148, 0.056127, 0.050164, 0.044489, 0.038521, 0.034780, 0.030471, 0.028014, 0.026694, 0.028223, 0.028199, 0.026672, 0.027146, 0.031050, 0.035478, 0.038799, 0.043243, 0.047547, 0.054110, 0.061220, 0.070691, 0.078761, 0.083699
#*# 	  0.106980, 0.103967, 0.097387, 0.092216, 0.086467, 0.079818, 0.072578, 0.067103, 0.060436, 0.055055, 0.048661, 0.042194, 0.038808, 0.035435, 0.034001, 0.032231, 0.032391, 0.032159, 0.032482, 0.032403, 0.035808, 0.041206, 0.045243, 0.048322, 0.053687, 0.061025, 0.069482, 0.076527, 0.086506, 0.093052
#*# 	  0.105817, 0.100762, 0.098241, 0.092755, 0.084255, 0.076963, 0.071051, 0.067221, 0.060874, 0.053380, 0.048575, 0.044630, 0.039350, 0.034969, 0.033253, 0.032641, 0.033345, 0.032387, 0.035193, 0.037219, 0.038732, 0.042014, 0.048910, 0.052548, 0.056045, 0.063122, 0.073676, 0.082775, 0.089831, 0.096244
#*# 	  0.108665, 0.105205, 0.098477, 0.093241, 0.087979, 0.080911, 0.073672, 0.067709, 0.062644, 0.056456, 0.050138, 0.045580, 0.041138, 0.037925, 0.035484, 0.035274, 0.036099, 0.037989, 0.039878, 0.042026, 0.045067, 0.049090, 0.054379, 0.059198, 0.064628, 0.072527, 0.080903, 0.089701, 0.100096, 0.106748
#*# 	  0.117462, 0.113516, 0.109178, 0.104022, 0.098575, 0.090559, 0.081721, 0.077212, 0.071605, 0.066454, 0.058424, 0.054587, 0.051663, 0.048283, 0.045135, 0.045257, 0.046563, 0.048443, 0.051062, 0.053570, 0.057297, 0.059984, 0.064648, 0.070508, 0.077159, 0.085510, 0.093510, 0.104612, 0.114425, 0.121339
#*# 	  0.133938, 0.128529, 0.121904, 0.118176, 0.113543, 0.104962, 0.096170, 0.089929, 0.083468, 0.077697, 0.072048, 0.067658, 0.064526, 0.061338, 0.058368, 0.057654, 0.058463, 0.061018, 0.063743, 0.067537, 0.070569, 0.074798, 0.080300, 0.086418, 0.093285, 0.102985, 0.111729, 0.121467, 0.133819, 0.142893
#*# 	  0.151976, 0.142211, 0.135733, 0.133102, 0.126780, 0.118420, 0.110177, 0.103934, 0.096639, 0.090310, 0.085189, 0.080829, 0.077144, 0.074040, 0.071369, 0.070802, 0.070907, 0.073487, 0.076709, 0.080195, 0.083347, 0.088802, 0.097407, 0.104686, 0.109375, 0.119547, 0.129663, 0.141588, 0.151365, 0.161605
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 325.0
#*# min_y = 30.0
#*# max_y = 315.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.997
#*# pid_ki = 1.828
#*# pid_kd = 355.701
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 67.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.8
