[include stealthburner.cfg]
[include homing.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include stealthburner_leds.cfg]
[include macros/fan_tach_monitor.cfg]

[exclude_object]

# Host-MCU definieren
[mcu host_mcu]
serial: /tmp/klipper_host_mcu

[mcu]
##  Obtain definition by "ls /dev/serial/by-id/*" then unplug to verify
##--------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_2D003B000851313031393839-if00
restart_method: command
##--------------------------------------------------------------------

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor RaspberryPi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[printer]
kinematics: corexy
max_velocity: 800  
max_accel: 10000             #Max 4000
max_z_velocity: 30          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 500
square_corner_velocity: 15.0

[force_move]
enable_force_move: True

#####################################################################
#   Cartographer Settings
#####################################################################

[mcu scanner]
serial: /dev/serial/by-id/usb-Cartographer_614e_33001F00104330394D363620-if00


[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 25                                                     #    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.5                                               #   Backlash compensation distance for removing Z backlash before measuring the sensor response.
sensor: cartographer                                             #    this must be set as cartographer unless using IDM etc.
sensor_alt: carto                                                #    alternate name to call commands. CARTO_TOUCH etc
mesh_runs: 2                                                     #    Number of passes to make during mesh scan.

[bed_mesh]
zero_reference_position: 175, 175    #    set this to the middle of your bed
speed: 200    #    movement speed of toolhead during bed mesh
horizontal_move_z: 5    #    height of scanner during bed mesh scan
mesh_min: 25, 30    #    start point of bed mesh [X, Y]
mesh_max: 325, 315    #    end point of bed mesh [X, Y]
probe_count: 30, 30
algorithm: bicubic

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[adxl345]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 20


#####################################################################
#   X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 351
position_max: 351
homing_speed: 80
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PC4
interpolate: true
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG6
driver_SGTHRS: 100

[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: tmc2209_stepper_y:virtual_endstop #Y_STOP
position_min: 0
position_endstop: 358
position_max: 358
homing_speed: 40 #50
homing_retract_dist: 0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PD11
interpolate: true
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG9
driver_SGTHRS: 95



[input_shaper]
#shaper_type_x = ei
#shaper_freq_x = 66.6
#shaper_type_y = ei
#shaper_freq_y = 49.4


#####################################################################
#   Z Stepper Settings
#####################################################################

## Z0 Stepper - Front Left
##  Connected to MOTOR_2
##  Endstop connected to DIAG_2
[stepper_z]
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16
endstop_pin: probe:z_virtual_endstop # uses cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 310

##--------------------------------------------------------------------
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Left
##  Connected to MOTOR_3
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Rear Right
##  Connected to MOTOR_4
[stepper_z2]
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z3 Stepper - Front Right
##  Connected to MOTOR_5
[stepper_z3]
step_pin: PC13
dir_pin: !PF0
enable_pin: !PF1
rotation_distance: 40
gear_ratio: 80:16
microsteps: 16 #32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z3]
uart_pin: PE4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA2
sensor_type: Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769


#####################################################################
#   Fan Control
#####################################################################

[controller_fan controller_fan]
pin: PA8
kick_start_time: 0.5
heater: heater_bed

[controller_fan controller_fan2]
pin: PE5
kick_start_time: 0.5
heater: heater_bed


#[temperature_fan controller_fan]
#pin: PD12
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#sensor_type: temperature_mcu
#sensor_pin:
#max_delta:
#min_temp: 40
#max_temp: 60
# Siehe Abschnitt "Extruder" für eine Beschreibung der oben genannten Parameter.
#pid_Kp:
#pid_Ki:
#pid_Kd:
# Die Proportional- (pid_Kp), Integral- (pid_Ki) und Ableitungswerte (pid_Kd) für das PID-Regelsystem.
# Klipper bewertet die PID-Einstellungen mit der folgenden allgemeinen Formel:
# fan_pwm = max_power - (Kp*e + Ki*integral(e) - Kd*derivative(e)) / 255
# wobei "e" "Zieltemperatur - gemessene Temperatur" ist und "fan_pwm" die angeforderte Lüfterrate ist,
# wobei 0,0 für "voll aus" und 1,0 voll ein ist. Die Parameter pid_Kp, pid_Ki und pid_Kd müssen
# bereitgestellt werden, wenn der PID-Regelalgorithmus aktiviert ist.
#pid_deriv_time: 2.0
# Ein Zeitwert (in Sekunden), über den die Temperaturmessungen geglättet werden, wenn der PID-
# Regelalgorithmus verwendet wird. Dies kann die Auswirkung Auswirkungen des Messrauschens. Die
# Vorgabe ist 2 Sekunden.
#target_temp: 40.0
# Eine Temperatur (in Celsius), die die Zieltemperatur sein wird. Die Vorgabe ist 40 Grad.
#max_speed: 1.0
# Die Lüftergeschwindigkeit (ausgedrückt als Wert von 0,0 bis 1,0), auf die der Lüfterausgedrückt als
# Wert von 0,0 bis 1,0), auf die der Lüfter eingestellt # wird, wenn die Sensortemperatur den
# eingestellten Wert überschreitet. Der Standardwert ist 1.0.
#min_speed: 0.3


[temperature_fan chamber]
pin: PD14
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time:0.01
off_below:0.1
sensor_type: DS18B20
serial_no: 28-01131a4d91b8
sensor_mcu: host_mcu  
ds18_report_time: 3.0
min_temp: 0
max_temp: 70
target_temp: 35.0
control: watermark
gcode_id: C

#####################################################################
#   LED Control
#####################################################################

[output_pin Licht]
pin: PA3
pwm:true
shutdown_value: 0
value:1
cycle_time: 0.01

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[safe_z_home]
home_xy_position: 175,175
z_hop: 10
speed: 250

[quad_gantry_level]

gantry_corners:
   -60,-10
   410,420
points:
   50,25
   50,275
   300,275
   300,25

speed: 350
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 20

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#####################################################################
#   Macros
#####################################################################
[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    PARK
    RESTORE_GCODE_STATE NAME=STATE_G32

[gcode_macro M141]                                                #Kammertemperatur von Slicer zu Klipper uebersetzen
gcode:
    {% if 'S' in params %}
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={params.S}
    {% else %}
    RESPOND PREFIX="M141" MSG="Missing parameter Snn"
    {% endif %}
    
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  SET_GCODE_OFFSET Z=0                                 # Set offset to 0
  
  M104 S150  #Düse schon mal auf 150°C Aufheizen ohne zu warten
  M140 S60 #Bett schon mal auf 60°C Aufheizen ohne zu warten
  
  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  STATUS_HOMING                                         # Set LEDs to homing-mode
  SET_DISPLAY_TEXT MSG="So, wo ist denn eigentlich mein Druckkopf?"
  G28                                                   # Full home (XYZ)
  G90                                                   # Absolute position
  BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)
  SET_DISPLAY_TEXT MSG="Jetzt weiss ich wieder, wo mir der Kopf steht"
  
  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                           # Turn on the PT-fan

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Das Bett ist ganz kalt. Warten wir lieber mal 3min."               # Display info on display
    G4 P180000                                          # Wait 5 min for the bedtemp to stabilize
  {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  M109 S150                                             # Heat hotend to 150c

  SET_DISPLAY_TEXT MSG="Jetzt wird das Gestell ausgerichtet"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  G1 Z30 F6000 
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  G28 Z                                                # Home Z again after QGL

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Lass mich noch schnell die Bettoberflaeche vermessen"                      # Display info on display
  STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  BED_MESH_CALIBRATE                                   # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh
  SET_DISPLAY_TEXT MSG="Jetzt noch die Düse sauber machen"
  CLEAN_NOZZLE
  SET_DISPLAY_TEXT MSG="Ich ermittle nun den gaaanz genauen Düsenabstand zum Bett"
  CARTOGRAPHER_TOUCH                                   # Calibrate z offset only with hot nozzle

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Düse aufheizen: {target_extruder}°C"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  SET_DISPLAY_TEXT MSG="Ich drücke mir nun die ersten 5cm Filament raus"
  PURGE_NOZZLE
  SET_DISPLAY_TEXT MSG="Jetzt geht's los. Düse {target_extruder}°C, Bett {target_bed}°C"
  G90
  G1 Z5 F1000
  G1 X175 Y175 F16000


[gcode_macro CANCEL_PRINT]
gcode:
    G90                        ; relative Positionen
    G1 Z300 F3000                ; Z 50 mm hoch
    G1 X350 Y350 F16000        ; Kopf nach X350 Y350 fahren
    M18                       ; Motoren deaktivieren (optional)

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}

    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament

    TURN_OFF_HEATERS

    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan

    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0


[gcode_macro CLEAN_NOZZLE]
variable_start_x: 313 #285
variable_start_y: 358
variable_start_z: 2.8
variable_wipe_dist: -50
variable_wipe_qty: 10
variable_wipe_spd: 150
variable_raise_distance: 30

gcode:
 {% if "xyz" not in printer.toolhead.homed_axes %}
   G28
 {% endif %}
 
 G90                                            ; absolute positioning
 ## Move nozzle to start position
 G1 X{start_x} Y{start_y} F5000
 G1 Z{start_z} F1500

 {% set current_y = start_y %}
 {% set y_increment = 0.1 %}
 {% set min_y = start_y - 1 %}

 ## Wipe nozzle with Y shifting
 {% for wipes in range(1, (wipe_qty + 1)) %}
   {% set current_y = current_y - y_increment %}
   {% if current_y < min_y %}
     {% set current_y = min_y %}
   {% endif %}
   
   G1 X{start_x + wipe_dist} Y{current_y} F{wipe_spd * 60}
   G1 X{start_x} Y{current_y} F{wipe_spd * 60}
 {% endfor %}

 ## Raise nozzle
 G91                      ; relative Positionierung
 G1 Z{raise_distance} F1000 ; Düse anheben
 G90                      ; zurück zu absolut



[gcode_macro PURGE_NOZZLE]
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    G28
  {% endif %}

  # Prüfen ob Hotend-Temperatur >= 180°C, sonst vorheizen
  {% set current_temp = printer.extruder.temperature %}
  {% if current_temp < 180 %}
    M109 S180               ; auf 180°C vorheizen und warten
  {% endif %}

  G90                      ; absolute Positionierung
  G1 X350 Y358 Z2.8 F5000 ; zum Behälter fahren
  G92 E0                   ; Extruder nullen
  G1 E30 F100              ; 30 mm Filament extrudieren (10 mm/s)
  G92 E0                   ; Extruder wieder nullen

  CLEAN_NOZZLE             ; Düse reinigen



[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_z_offset = 0.055
#*#
#*# [scanner model default]
#*# model_coef = 1.5092638035040915,
#*# 	1.9312080264466045,
#*# 	0.7662534622402828,
#*# 	0.3951616289841105,
#*# 	0.22456808776817896,
#*# 	0.029459435831755323,
#*# 	-0.07131374548365897,
#*# 	0.10425387126481561,
#*# 	0.12319043327851449,
#*# 	-0.006975329077736644
#*# model_domain = 3.22431194029789e-07,3.2899413558884275e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.268064
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.235253, 0.220771, 0.214804, 0.206675, 0.197529, 0.187703, 0.180197, 0.172851, 0.166126, 0.160199, 0.157643, 0.155171, 0.155910, 0.154347, 0.154296, 0.154393, 0.157172, 0.159496, 0.163097, 0.165989, 0.171864, 0.180383, 0.186612, 0.190311, 0.194623, 0.202516, 0.208328, 0.210640, 0.213755, 0.217080
#*# 	0.204398, 0.197166, 0.190502, 0.183669, 0.176325, 0.167090, 0.159479, 0.153457, 0.145977, 0.138959, 0.135600, 0.135178, 0.134812, 0.132346, 0.132070, 0.132819, 0.135723, 0.136315, 0.138753, 0.143434, 0.148972, 0.157897, 0.163396, 0.167118, 0.171003, 0.177076, 0.184638, 0.188165, 0.189576, 0.192193
#*# 	0.178649, 0.174118, 0.166430, 0.160054, 0.153194, 0.144531, 0.135874, 0.129497, 0.121700, 0.115461, 0.111434, 0.110470, 0.110623, 0.108238, 0.106464, 0.107807, 0.110059, 0.111621, 0.113139, 0.116187, 0.123963, 0.131395, 0.135535, 0.139935, 0.144751, 0.149884, 0.155853, 0.159251, 0.162655, 0.164743
#*# 	0.154711, 0.150937, 0.144844, 0.137489, 0.129525, 0.122672, 0.113613, 0.107398, 0.099382, 0.094702, 0.090498, 0.089441, 0.088755, 0.086777, 0.085381, 0.084516, 0.087202, 0.088636, 0.089017, 0.092505, 0.099883, 0.107523, 0.110898, 0.113863, 0.120030, 0.125508, 0.130760, 0.133642, 0.136569, 0.139294
#*# 	0.139753, 0.134209, 0.129173, 0.123513, 0.116821, 0.107766, 0.101044, 0.093280, 0.086884, 0.082069, 0.080165, 0.077786, 0.075995, 0.074417, 0.071832, 0.071931, 0.073334, 0.075226, 0.076925, 0.078731, 0.084282, 0.092900, 0.096911, 0.098479, 0.102282, 0.109512, 0.115274, 0.118510, 0.120965, 0.124324
#*# 	0.133454, 0.128195, 0.124308, 0.119328, 0.110789, 0.102735, 0.094549, 0.088565, 0.082407, 0.077153, 0.075094, 0.072138, 0.071577, 0.069093, 0.065842, 0.065830, 0.066618, 0.067857, 0.069786, 0.071861, 0.077708, 0.084618, 0.089750, 0.092706, 0.096448, 0.100453, 0.108140, 0.112140, 0.115889, 0.117592
#*# 	0.129487, 0.124452, 0.120969, 0.115547, 0.108660, 0.100103, 0.092959, 0.085142, 0.078984, 0.073443, 0.067456, 0.064937, 0.064932, 0.063154, 0.058529, 0.058129, 0.058933, 0.059049, 0.060148, 0.063353, 0.068060, 0.075601, 0.079514, 0.084106, 0.088782, 0.093883, 0.098329, 0.103977, 0.107720, 0.110582
#*# 	0.133846, 0.128001, 0.123589, 0.118238, 0.110092, 0.102175, 0.093897, 0.086418, 0.077589, 0.071660, 0.066623, 0.062244, 0.060616, 0.059181, 0.056341, 0.053799, 0.054995, 0.056467, 0.056340, 0.057643, 0.062855, 0.069086, 0.073975, 0.078474, 0.082790, 0.088456, 0.093606, 0.098159, 0.103102, 0.106035
#*# 	0.138687, 0.132072, 0.126582, 0.119960, 0.111972, 0.101085, 0.094026, 0.085603, 0.076592, 0.070154, 0.065785, 0.061368, 0.057802, 0.056851, 0.056011, 0.052937, 0.051947, 0.051793, 0.052100, 0.053494, 0.056438, 0.062930, 0.067323, 0.069562, 0.073958, 0.080693, 0.087167, 0.091987, 0.097984, 0.102609
#*# 	0.142220, 0.133867, 0.126933, 0.120116, 0.112091, 0.102421, 0.091788, 0.083783, 0.074495, 0.067058, 0.061808, 0.059208, 0.055675, 0.052056, 0.050303, 0.049358, 0.047234, 0.045847, 0.045327, 0.047002, 0.049999, 0.054151, 0.059863, 0.062894, 0.067992, 0.075080, 0.081752, 0.086979, 0.092112, 0.096542
#*# 	0.137019, 0.126611, 0.119862, 0.111437, 0.103458, 0.093238, 0.084797, 0.075368, 0.068625, 0.059908, 0.053165, 0.049300, 0.047133, 0.043961, 0.040055, 0.037614, 0.036501, 0.034432, 0.034125, 0.036965, 0.040820, 0.044714, 0.046011, 0.051538, 0.058268, 0.063546, 0.070171, 0.076826, 0.083079, 0.086172
#*# 	0.129702, 0.120185, 0.112624, 0.105829, 0.097972, 0.087355, 0.078521, 0.069897, 0.061608, 0.053696, 0.045887, 0.040389, 0.037270, 0.037215, 0.032854, 0.029443, 0.028955, 0.028211, 0.028920, 0.029985, 0.034182, 0.038502, 0.039170, 0.044414, 0.050200, 0.056456, 0.062691, 0.066638, 0.073978, 0.077484
#*# 	0.122196, 0.113760, 0.107691, 0.100839, 0.092090, 0.081498, 0.073730, 0.064582, 0.056227, 0.048651, 0.039427, 0.034783, 0.030856, 0.029613, 0.026885, 0.023851, 0.022858, 0.023389, 0.024585, 0.025166, 0.027764, 0.033608, 0.037004, 0.039077, 0.043512, 0.050284, 0.057128, 0.061622, 0.068547, 0.072622
#*# 	0.109877, 0.102017, 0.095795, 0.089481, 0.080752, 0.070845, 0.061769, 0.055548, 0.047801, 0.038709, 0.029203, 0.024453, 0.021063, 0.017964, 0.015279, 0.015828, 0.015445, 0.014226, 0.015155, 0.017854, 0.020552, 0.023774, 0.029132, 0.031981, 0.037268, 0.042236, 0.049405, 0.054118, 0.060635, 0.064706
#*# 	0.099239, 0.091203, 0.085415, 0.078799, 0.070215, 0.061539, 0.051846, 0.046231, 0.037706, 0.029195, 0.020335, 0.016154, 0.013285, 0.010533, 0.008341, 0.007996, 0.008885, 0.008112, 0.007927, 0.011260, 0.015518, 0.020367, 0.023362, 0.029301, 0.034787, 0.040067, 0.045755, 0.052601, 0.058572, 0.062015
#*# 	0.093158, 0.086379, 0.081849, 0.074644, 0.066280, 0.056650, 0.047907, 0.041543, 0.035433, 0.027071, 0.019830, 0.014929, 0.011143, 0.007007, 0.004759, 0.004806, 0.006092, 0.004978, 0.005047, 0.006730, 0.011626, 0.017605, 0.022842, 0.026762, 0.034124, 0.040379, 0.047103, 0.052170, 0.059453, 0.062544
#*# 	0.083386, 0.077420, 0.072540, 0.065440, 0.058363, 0.048979, 0.042170, 0.033406, 0.028535, 0.021975, 0.015858, 0.009572, 0.005730, 0.002161, -0.000086, -0.000442, -0.000210, 0.001805, 0.003968, 0.002874, 0.007277, 0.011991, 0.018438, 0.021221, 0.028452, 0.037812, 0.044834, 0.052278, 0.059569, 0.063953
#*# 	0.079549, 0.074079, 0.065557, 0.058790, 0.051610, 0.044047, 0.036168, 0.029453, 0.023584, 0.016615, 0.010675, 0.006589, 0.002687, -0.000461, -0.002973, -0.003126, -0.002633, -0.001440, 0.002665, 0.002967, 0.005648, 0.009645, 0.016586, 0.021007, 0.027547, 0.036159, 0.044626, 0.051404, 0.057783, 0.062787
#*# 	0.080220, 0.072367, 0.065941, 0.058384, 0.052050, 0.044717, 0.038236, 0.031591, 0.026720, 0.018163, 0.011670, 0.007644, 0.003383, -0.000041, -0.004120, -0.002471, 0.000834, 0.000442, 0.000709, 0.002753, 0.007919, 0.012683, 0.018445, 0.022829, 0.027902, 0.035176, 0.042424, 0.052291, 0.061217, 0.066526
#*# 	0.086829, 0.080211, 0.072087, 0.064777, 0.057767, 0.051607, 0.045367, 0.038914, 0.030834, 0.024328, 0.016435, 0.013067, 0.009759, 0.005816, 0.002665, 0.002469, 0.004597, 0.006062, 0.004208, 0.006446, 0.012240, 0.018881, 0.022587, 0.024466, 0.028932, 0.035723, 0.044876, 0.051660, 0.060956, 0.067601
#*# 	0.093308, 0.085516, 0.078939, 0.070433, 0.063869, 0.057304, 0.053427, 0.047123, 0.039673, 0.030427, 0.026109, 0.021379, 0.017762, 0.013644, 0.009936, 0.010111, 0.010826, 0.011308, 0.012911, 0.012855, 0.016948, 0.023640, 0.027325, 0.028664, 0.031052, 0.040133, 0.048725, 0.055840, 0.064263, 0.072328
#*# 	0.109723, 0.103456, 0.096574, 0.089577, 0.083331, 0.075130, 0.070158, 0.064176, 0.057617, 0.049465, 0.044968, 0.039319, 0.034832, 0.030424, 0.027989, 0.027886, 0.027552, 0.027392, 0.028713, 0.029347, 0.031168, 0.035654, 0.039405, 0.041514, 0.045208, 0.052291, 0.061557, 0.069216, 0.076459, 0.082700
#*# 	0.125659, 0.119675, 0.112945, 0.106636, 0.100587, 0.094031, 0.086446, 0.079831, 0.074393, 0.069094, 0.060700, 0.055441, 0.052128, 0.047126, 0.043993, 0.043159, 0.044021, 0.042902, 0.041529, 0.042131, 0.046277, 0.049032, 0.051950, 0.055120, 0.059796, 0.065856, 0.072765, 0.082874, 0.089768, 0.094068
#*# 	0.129657, 0.124852, 0.119947, 0.114024, 0.109366, 0.101637, 0.094838, 0.089162, 0.083701, 0.076936, 0.069999, 0.064533, 0.059303, 0.057705, 0.053556, 0.051918, 0.052675, 0.050682, 0.049228, 0.049353, 0.054354, 0.057884, 0.060927, 0.064052, 0.068147, 0.074939, 0.082493, 0.089778, 0.097410, 0.102949
#*# 	0.134042, 0.129369, 0.125451, 0.120776, 0.115562, 0.106992, 0.102516, 0.095635, 0.090136, 0.082529, 0.076478, 0.071327, 0.067171, 0.063442, 0.061057, 0.059679, 0.059682, 0.059789, 0.058974, 0.059191, 0.061211, 0.065517, 0.070865, 0.072596, 0.076002, 0.083481, 0.091482, 0.098256, 0.104933, 0.112645
#*# 	0.137098, 0.132603, 0.129366, 0.124770, 0.118406, 0.112822, 0.106762, 0.101193, 0.094795, 0.088715, 0.084483, 0.077846, 0.073358, 0.070253, 0.069256, 0.067208, 0.067144, 0.066381, 0.069372, 0.070908, 0.071610, 0.075444, 0.080618, 0.083434, 0.087289, 0.093539, 0.102723, 0.109479, 0.116702, 0.123665
#*# 	0.146946, 0.142072, 0.137941, 0.132690, 0.128574, 0.120171, 0.114283, 0.108287, 0.104672, 0.099457, 0.092132, 0.087873, 0.084348, 0.080240, 0.077407, 0.077646, 0.080507, 0.079879, 0.080749, 0.083672, 0.086537, 0.088555, 0.093502, 0.099118, 0.103010, 0.108869, 0.117003, 0.126213, 0.134561, 0.140395
#*# 	0.158883, 0.155616, 0.150216, 0.145358, 0.141425, 0.134723, 0.126842, 0.121613, 0.118296, 0.113115, 0.106322, 0.101423, 0.098609, 0.096025, 0.091830, 0.092085, 0.093645, 0.095680, 0.096730, 0.100033, 0.102671, 0.105539, 0.110553, 0.115417, 0.122004, 0.128971, 0.136894, 0.146234, 0.155868, 0.162857
#*# 	0.180266, 0.177013, 0.174242, 0.170510, 0.165148, 0.157985, 0.150264, 0.145197, 0.139664, 0.135520, 0.129546, 0.126046, 0.121621, 0.119273, 0.117744, 0.116172, 0.116107, 0.118397, 0.121093, 0.122475, 0.125279, 0.130545, 0.136033, 0.140796, 0.146861, 0.156896, 0.165063, 0.173982, 0.184315, 0.192820
#*# 	0.207540, 0.201593, 0.197292, 0.195429, 0.190398, 0.182474, 0.175155, 0.169323, 0.163955, 0.158274, 0.153393, 0.151583, 0.148783, 0.145879, 0.142368, 0.139616, 0.139533, 0.140654, 0.143507, 0.146066, 0.149095, 0.154977, 0.164764, 0.169923, 0.174554, 0.182513, 0.192493, 0.202991, 0.213429, 0.220887
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 325.0
#*# min_y = 30.0
#*# max_y = 315.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.997
#*# pid_ki = 1.828
#*# pid_kd = 355.701
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 67.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 40.8
