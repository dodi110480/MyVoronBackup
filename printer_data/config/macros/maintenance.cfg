[gcode_macro TEST_FILAMETRIX_CUT]
description: Testet Filametrix Cutter und Entladevorgang (homed + auch bei kalter Düse)
gcode:
  {% set retract_length = 50 %}
  {% set retract_speed = 25 %}
  {% set center_x = 175 %}
  {% set center_y = 175 %}

  M118 === Starte Filametrix Cutter-Test ===

  {% if not printer.toolhead.homed_axes == "xyz" %}
    M118 Drucker ist nicht ge-homed – führe G28 aus...
    G28
  {% endif %}

  {% set oldx = printer.gcode_move.gcode_position.x %}
  {% set oldy = printer.gcode_move.gcode_position.y %}
  {% set oldz = printer.gcode_move.gcode_position.z %}

  M118 -> Fahre zum Cutter Startpunkt
  G90
  G1 Y29.5 Z30 F6000
  G1 X10.9 F6000

  M118 -> Cutter wird ausgelöst (X=0 Y=29.5)
  G1 X0 Y29.5 F1800
  G1 X180 Y29.5 F1800
  G4 P500

  M118 -> Fahre zur Bettmitte
  G1 X{center_x} Y{center_y} F6000

  M118 -> Erlaube kaltes Retract für Test
  SET_E_CAPS ENABLE_EXTRUDE_WHEN_COLD=1

  M118 -> Ziehe {retract_length}mm Filament bei {retract_speed}mm/s zurück
  G91
  G1 E-{retract_length} F{retract_speed * 60}
  G90

  M118 -> Deaktiviere kaltes Extrudieren wieder
  SET_E_CAPS ENABLE_EXTRUDE_WHEN_COLD=0

  M118 -> Rückkehr zur ursprünglichen Position
  G1 X{oldx} Y{oldy} Z{oldz} F6000

  M118 === Filametrix-Test abgeschlossen ===